# Перед работой
Проверь, что у тебя есть:
1) Развернутый домен FreeIPA
2) Развернутный CEPH на трех нодах
3) Настроенная DNS-инфраструктура
4) Примонтированная через FSTAB папка CEPH, по инструкции ceph-deploy.md

По итогу выполнения данной инструкции мы получим отказоустойчивую Samba-сетевую папку, к которой  можно будет подключать пользователей исходя из их членства в группе. Также, в случае падения одной из Samba-нод keepalived легко перенесет активных клиентов на новый хост, который подхватит клиентов. Даунтайм примерно 10-15 секунд.

# Приступаем к работе
# На контроллере домена:
Получите Kerberos-ключ для админа, чтобы прозводить работы с доменом. 
```console
$ kinit admin
```
Установите на сервере FreeIPA поддержу SID
```console
$ ipa-adtrust-install --add-sids --add-agents
```
Получите на контроллере домена набор SID
```console
$ net getdomainsid
```
В ответ команда вернет вам два SID. Один для local machine, другой доменный. Доменный нужно сохранить. 
Например: 
```console
$ net getdomainsid > test.txt
```
Потом test.txt нужно отредактировать, уберите оттуда всё,кроме самого SID вашего домена. SID начинается на символы S-1-....
Далее необходимо получить диапазон ID, которые испольузет ваш домен.
```console
$ ipa idrange-find --raw
```
В ответ придет количество диапазонов. Для FreeIPA по умолчанию ipabaseid равен 624000, а ipaidrangesize - 1000000.
Если у вас значения такие же, то идём по мануалу дальше. Если нет, то решите простой арифметический пример:
```console
$ ipabaseid + ipaidrangesize - 1 
```
Полученное значение - это последний индентификатор пользователя в вашем домене.
Далее в веб-интерфейсе добавь новый узел.
Такого хоста на самом деле не будет, но в "узлах" запись о нём быть должна. Имя узла - smb.wsr.local.
Адрес - .250 адрес в твоей сети (или любой другой, это адрес будет виртуальным общим адресом для keepalived).
Проверь, обязательно, что DNS-запись smb.wsr.local отображется  именно в твой общий IP-адрес.            
# На файловом сервере
Назначь на компьютер IP-адрес и добавь его в домен через astra-freeipa-client.
Далее, установи: 
```console
$ sudo apt install libwbclient-sssd samba winbind freeipa-admintools
```
После этого (данные задачи можно делать на файловом сервере если поставил freeipa-admintools или на доменном контроллере): 
Получи тикет admin'a
```console
$ kinit admin
```
Зарегистрируй в домене новую службу
```console
$ ipa service-add cifs/smb.wsr.local
```
Далее, на файловом сервере:
```console
$ mkdir /mnt/shared
```
Получи таблицу ключей Kerberos:
```console
$ ipa-getkeytab -s <your_DC> -p cifs/smb.wsr.local -k /etc/samba/samba.keytab
```
your_DC - имя DNS твоего доменного контроллера, в случае автора статьи:
```console
$ ipa-getkeytab -s ca-srv.wsr.local -p cifs/smb.wsr.local -k /etc/samba/samba.keytab
```
Далее настрой /etc/samba/smb.conf. (есть тут же в гитлабе)
После этого, помнишь SID сохраняли? Теперь пора им воспользоваться. Перенеси test.txt на машину, где твоя Samba папка и затем:
```console
$ sudo net setdomainsid $(cat  test.txt)
```
После этого перезагрузи службу:
```console
$ kinit admin
```

```console
$ sudo systemctl restart smbd winbind
```
После этого первая папка готова. 
Как проверить? 
Правильнее всего в нашем случае, это примонтировать сразу через pam_mount.conf.xml.
Установи на клиентской машине:
```console
$ sudo apt install libpam-mount
```
Файл pam_mount.conf.xml также есть в этом репозитории.
После этого попытайся войти под тем логином и паролем пользователя из той группы, которую ты прописал в smb.conf.
На данном этапе Samba папка готова, теперь необходимо реализовать механизм Keepalived.

Keepalived есть в полном формате в этом репозитории - keepalived.conf.
Там одновременно реализован как механизм PG, так и Samba. Возьми уже оттуда все что хочешь. 
Немного про keepalived.
Он трекает не только статус доступности по адресу, но и статус работы Samba.
То есть если сама Самба упадет, Keepalived об этом узнает и перекинет пользаков.
Сделает это он через скрипт /usr/smb_check, который также есть в этом репозитории. Склонируй её и выдай прав


